<html>
	<head>
		<title>Scene State Configuration</title>
		<link rel="stylesheet" href="../release/bootstrap.min.css">
		<link rel="stylesheet" href="../release/designer/designer.css">
		[script]
	</head>
	<body>
		<script type="text/javascript">

			window.onload = function(){

				var sceneSelectorConfig;
				var workflowConfig;
				var modalWindowTextEditor;
				var modalWindowTextBoxUsername;
				var modalWindowTextBoxPassword;
				var modalWindowCheckbox;
				var modalWindow = new ModalWindow();
				var diagramCanvas = new DiagramCanvas();
				var phaserCanvas = new PhaserCanvas();
				var diagramCanvasContextMenu = new DiagramCanvasContextMenu();
				var diagramCanvasPublishButton = new DiagramCanvasButton("Publish");
				var phaserCanvasButton = new PhaserCanvasButton("Close");
				phaserCanvasButton.hide();

				phaserCanvasButton.subscribe(function onclick(){
					factory(function(_instance){
						_instance.phaserGame(function(_game){
							_game.exit();
							diagramCanvas.show();
							phaserCanvas.hide();
							phaserCanvasButton.hide();
						});
					});
				});

				diagramCanvasPublishButton.subscribe(function onclick(){
					var url = "/publish?fileName=letfly.zip";
					$.post(url, function(){
						window.location.href = "/downloads/letfly.zip";
					});
				});

				diagramCanvasContextMenu.addMenuItem("Preview Scene",function(){
					var sceneJSON = modalWindowTextEditor.getValue();
					var selectedSceneConfig = JSON.parse(sceneJSON);
					factory(function(_instance){
						diagramCanvas.hide(false);
						setTimeout(function(){
							_instance.phaserGame(function(_game){
								sceneJSON = modalWindowTextEditor.getValue();
								selectedSceneConfig = JSON.parse(sceneJSON);
								_game.start(selectedSceneConfig.name, selectedSceneConfig.template, function(){
									phaserCanvas.show();
									phaserCanvasButton.show();
								});
							});
						},200);
					});
				});

				diagramCanvasContextMenu.addMenuItem("Edit Scene Objects",function(){

					var username = modalWindowTextBoxUsername.getValue();
					var password = modalWindowTextBoxPassword.getValue();
					var sceneJSON = modalWindowTextEditor.getValue();
					var selectedSceneConfig = JSON.parse(sceneJSON);
					var sceneObjId = selectedSceneConfig.name;
					sceneObjId = sceneObjId.replace(" ","").toLowerCase();
					sceneObjId = sceneObjId + selectedSceneConfig.template;

					modalWindow.clear();
					modalWindowTextEditor = new ModalWindowTextEditor("configEditor");
					modalWindowCheckbox = new ModalWindowCheckBox("Replace with template");


					var modalWindowButtonConfig = new ModalWindowButton("Submit",true);
					getConfigFromGithub(sceneObjId, username, password, function(_sceneConfig){

						getConfigFromGithub("templates/"+selectedSceneConfig.template, username, password, function(_sceneConfigTpl){
							
							if (_sceneConfig){
								modalWindowTextEditor.populate(_sceneConfig);
							}else{
								if (!_sceneConfigTpl){
									throw selectedSceneConfig.template + " template was not found.";
								}else{
									modalWindowTextEditor.populate(_sceneConfigTpl);
								}
							}

							modalWindowCheckbox.subscribe(function onclick(){
								if (modalWindowCheckbox.isChecked()){
									modalWindowTextEditor.populate(_sceneConfigTpl);
								}else{
									modalWindowTextEditor.populate(_sceneConfig);
								}
							});

							modalWindow.setTitle("Scene Object Config","Edit the scene object configuration.");
							modalWindow.show();
							modalWindowButtonConfig.subscribe(function onclick(){
								var username = modalWindowTextBoxUsername.getValue();
								var password = modalWindowTextBoxPassword.getValue();
								if (username && password){
									var updatedSceneObjConfigJSON = modalWindowTextEditor.getValue();
									var updatedSceneObjConfig = JSON.parse(updatedSceneObjConfigJSON);
									sendToGithub(sceneObjId, username, password, updatedSceneObjConfig, function(){
										
									});
								}
							});
							setTimeout(function(){
								modalWindowTextEditor.focus();
							},1000);
						});
					});
				});
				diagramCanvasContextMenu.addMenuItem("Edit Scene Config", function(){
					modalWindow.setTitle("State Config","Edit the configuration for the selected state.");
					modalWindow.show();
					setTimeout(function	(){
						modalWindowTextEditor.focus();
					},200);
				});

				diagramCanvas.nodeMoveStart = function(){
					diagramCanvasContextMenu.hide();
				};
				diagramCanvas.nodeMoveEnd = function(){
					diagramCanvasContextMenu.show();
					diagramCanvasContextMenu.centreToMouse();
				};
				diagramCanvas.selectedNode = function(_selectedNode){

						diagramCanvasContextMenu.centreToMouse();
					diagramCanvasContextMenu.show();
					setTimeout(function(){
						var existingConfig = null;
						enumerate(sceneSelectorConfig, this, function(sceneSelectorConfigItem){
							if (_selectedNode.Id == sceneSelectorConfigItem.Id) {
								existingConfig = sceneSelectorConfigItem;
							}
						},function(){
							if (!existingConfig){
								existingConfig = {
									Id: _selectedNode.Id,
									name:_selectedNode.text,
									template:""
								};
								sceneSelectorConfig.push(existingConfig);
							}

							modalWindow.clear();
							modalWindowTextEditor = new ModalWindowTextEditor("configEditor");
							modalWindowCheckbox = new ModalWindowCheckBox("Save All");
							var modalWindowButtonConfig = new ModalWindowButton("Submit",true);
							modalWindowButtonConfig.subscribe(function onclick(){
								var isSelected = modalWindowCheckbox.isChecked();
								setSceneConfig();
								if (isSelected){
									var username = modalWindowTextBoxUsername.getValue();
									var password = modalWindowTextBoxPassword.getValue();
									if (username && password){
										var prioritisedNodeArray = [];
										var links = [];
										var priority = 0;
										diagramCanvas.getNodeLinks(function(nodeLinks){
											diagramCanvas.getNodes(function(nodes){
												var _config = {
													links: nodeLinks, 
													nodes: nodes
												};
												sendToGithub("workflow", username, password, _config, function(){
													sendToGithub("sceneSelector", username, password, sceneSelectorConfig, function(){
													});
												});
											});
										});
									}
								}
							});
							modalWindowTextEditor.populate(existingConfig);
		
						});
					},100);	
				};
				diagramCanvas.nodeLostFocus = function(){
					setSceneConfig();
					diagramCanvasContextMenu.hide();
				};

				diagramCanvas.nodeDeleted = function(deletedNode){
					diagramCanvasContextMenu.hide();
					enumerate(sceneSelectorConfig, this, function(sceneSelectorConfigItem, cbCondition, cbRemove){
						if (deletedNode.Id == sceneSelectorConfigItem.Id){
							cbRemove();
						}
						enumerate(workflowConfig.nodes, this, function(_node, cbCondition2, cbRemoveNode){
							if (deletedNode.Id == _node.Id ){
								cbRemoveNode();
							}
						});
						enumerate(workflowConfig.links, this, function(_link, cbCondition, cbRemoveLink){
							if (_link.node == deletedNode.Id){
								cbRemoveLink();
							} else if (_link.nodeA != deletedNode.Id && _link.nodeB == deletedNode.Id) {
								cbRemoveLink();
							} else if (_link.nodeA == deletedNode.Id && _link.nodeB != deletedNode.Id) {
								cbRemoveLink();
							}
						});
						editor.clear();
					});
				};

				function setSceneConfig(){
					if (modalWindowTextEditor){
						var configJSON = modalWindowTextEditor.getValue();
						if (configJSON.length > 5){
							var config = JSON.parse(configJSON);
							enumerate(sceneSelectorConfig, this, function(sceneSelectorConfigItem){
								if (config.Id == sceneSelectorConfigItem.Id) {
									for (var prop in sceneSelectorConfigItem){
										sceneSelectorConfigItem[prop] = config[prop];
									};
								}
							});
						}
					}
				};

				function drawDiagrams(){
					var username = modalWindowTextBoxUsername.getValue();
					var password = modalWindowTextBoxPassword.getValue();

					getConfigFromGithub("workflow", username, password, function(_workflowConfig){
						workflowConfig = _workflowConfig;
						diagramCanvas.drawNodes(workflowConfig.nodes);
						diagramCanvas.drawLinks(workflowConfig.links);
						getConfigFromGithub("sceneSelector", username, password, function(_sceneSelectorConfig){
							sceneSelectorConfig = _sceneSelectorConfig;
						});	
					});
					modalWindowTextEditor = new ModalWindowTextEditor("configEditor");
				};

				var modalWindowButtonGithub = new ModalWindowButton("Submit",true);
				modalWindowButtonGithub.subscribe(function onclick(){
					drawDiagrams();
				});
				var username = "Marchuanv";
				modalWindowTextBoxUsername = new ModalWindowTextBox("githubUsername");
				modalWindowTextBoxUsername.setValue(username);
				modalWindowTextBoxPassword = new ModalWindowTextBox("githubPassword", true);
				modalWindow.setTitle("Enter Github username and password (Optional)",
								 "Save configuration changes to a branch in Github.");
				modalWindow.show();
				
			};
		</script>
	</body>
</html>
